- name: Copiar docker-compose.yml
  copy:
    src: files/docker-compose.yml
    dest: /home/vagrant/zabbix-docker-compose.yml
    owner: vagrant
    group: vagrant
    mode: '0644'

- name: Crear archivo .env para docker-compose
  copy:
    dest: /home/vagrant/.env
    content: |
      MYSQL_ROOT_PASSWORD={{ mysql_root_password }}
      MYSQL_DATABASE={{ mysql_database }}
      MYSQL_USER={{ mysql_user }}
      MYSQL_PASSWORD={{ mysql_password }}
      ZABBIX_VERSION={{ zabbix_version }}
    owner: vagrant
    group: vagrant
    mode: '0600'

- name: Crear directorio de datos
  file:
    path: /home/vagrant/zabbix_data
    state: directory
    owner: vagrant
    group: vagrant
    mode: '0755'

- name: Verificar que Docker esté funcionando para vagrant
  become: true
  shell: |
    # Reiniciar sesión del usuario vagrant para aplicar grupo docker
    systemctl restart docker
    sleep 3
    # Ejecutar docker como vagrant usando newgrp
    su - vagrant -c "newgrp docker; docker info"
  register: docker_check
  changed_when: false
  
- name: Levantar servicios con docker-compose
  become: true
  shell: |
    set -e
    cd /home/vagrant
    # Verificar que Docker funcione antes de continuar
    su - vagrant -c "newgrp docker; docker info > /dev/null"
    # Ejecutar docker compose como vagrant
    su - vagrant -c "cd /home/vagrant && newgrp docker; docker compose -f zabbix-docker-compose.yml up -d"
  register: compose_result
  
- name: Mostrar estado de los contenedores
  become: true
  shell: su - vagrant -c "newgrp docker; docker ps"
  register: containers_status
  changed_when: false

- name: Debug - mostrar contenedores
  debug:
    msg: "{{ containers_status.stdout_lines }}"